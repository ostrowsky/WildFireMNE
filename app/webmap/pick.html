<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pick coordinates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
    .panel {
      position:absolute; left:12px; top:12px; z-index:600;
      background:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 2px 12px rgba(0,0,0,.15);
      font:14px/1.25 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      max-width:min(92vw,420px);
    }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { padding:6px 10px; border:1px solid #e1e5ea; border-radius:8px; background:#fff; cursor:pointer; }
    .muted { color:#6b7280 }
    .val { font-weight:600 }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div><b>Choose point</b></div>
    <div class="muted" style="margin:6px 0 8px">Drag the pin or tap the map. Copy coords and paste back to Telegram chat.</div>
    <div class="row" style="margin-bottom:8px">
      <div>Lat: <span id="lat" class="val"></span></div>
      <div>Lon: <span id="lon" class="val"></span></div>
    </div>
    <div class="row">
      <button id="copyBtn" class="btn">Copy</button>
      <a id="gmaps" class="btn" target="_blank" rel="noopener">Google Maps</a>
      <a id="openmap" class="btn" target="_blank" rel="noopener">Open live map</a>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // placeholders from server
    const INIT = [parseFloat("__INIT_LAT__"), parseFloat("__INIT_LON__")];
    const CENTER = [parseFloat("__CENTER_LAT__"), parseFloat("__CENTER_LON__")];
    const ZOOM = parseInt("__CENTER_ZOOM__", 10) || 12;
    const MAP_TILER_KEY = "__MAP_TILER_KEY__";
    const OPENMAP_URL = "__OPENMAP_URL__";

    const map = L.map('map', { zoomControl:true }).setView(INIT || CENTER, ZOOM);
    // OSM base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
    // Optional MapTiler overlay
    const key = (MAP_TILER_KEY||'').trim();
    if (key && key.toLowerCase() !== 'disable') {
      L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${key}`, { maxZoom:20 }).addTo(map);
    }

    // Draggable marker
    const marker = L.marker(INIT, { draggable:true }).addTo(map);

    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const gmaps = document.getElementById('gmaps');
    const openmap = document.getElementById('openmap');
    openmap.href = OPENMAP_URL;

    function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }
    function updateUI(ll){
      latEl.textContent = fmt(ll.lat);
      lonEl.textContent = fmt(ll.lng);
      gmaps.href = `https://maps.google.com/?q=${fmt(ll.lat)},${fmt(ll.lng)}`;
    }
    updateUI(marker.getLatLng());

    marker.on('dragend', (e)=> updateUI(marker.getLatLng()));
    map.on('click', (e)=> { marker.setLatLng(e.latlng); updateUI(e.latlng); });

    document.getElementById('copyBtn').onclick = async ()=>{
      const s = `${fmt(marker.getLatLng().lat)}, ${fmt(marker.getLatLng().lng)}`;
      try {
        await navigator.clipboard.writeText(s);
        alert('Copied');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = s; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        alert('Copied');
      }
    };
  </script>
</body>
</html>
