<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
    .legend {
      position:absolute; right:12px; top:12px; z-index:600;
      background:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 2px 12px rgba(0,0,0,.15);
      font:14px/1.25 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .legend b{ display:block; margin-bottom:6px }
    .pill{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle }
    .red{ background:#e53935 } .blue{ background:#1e88e5 } .green{ background:#43a047 } .orange{ background:#ff6d00 }
    .toggle-fab{ position:absolute; right:12px; top:72px; z-index:650; border:1px solid #e1e5ea; border-radius:22px; padding:8px 12px; background:#fff; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.15); }
    .sidebar{ position:absolute; right:12px; top:112px; bottom:12px; z-index:640; width:320px; max-width:calc(100vw - 24px); background:#fff; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.15); display:flex; flex-direction:column; overflow:hidden; transition:transform .25s ease, opacity .25s ease; }
    .sidebar.collapsed{ transform:translateX(110%); opacity:0; pointer-events:none }
    .tabs{ display:flex; gap:8px; padding:10px 12px 0 }
    .tab{ flex:1; text-align:center; padding:10px 12px; border-radius:10px; cursor:pointer; background:#f1f3f5; user-select:none }
    .tab.active{ background:#e8f0fe; color:#1a73e8; font-weight:600 }
    .filters{ display:flex; align-items:center; gap:8px; padding:8px 12px }
    .filters input[type="text"]{ flex:1; padding:8px 10px; border:1px solid #e1e5ea; border-radius:8px; font:14px/1.2 inherit }
    .filters label{ font-size:13px; color:#555; white-space:nowrap }
    .list{ flex:1; overflow:auto; padding:0 12px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border:1px solid #eef1f4; border-radius:10px; margin:8px 0; background:#fff; cursor:pointer }
    .item:hover{ background:#fafbfd }
    .item .meta{ color:#6b7280; font-size:12px; margin-top:2px }
    .item .actions{ display:flex; gap:6px }
    .btn{ display:inline-block; padding:6px 10px; border:1px solid #e1e5ea; border-radius:8px; background:#fff; text-decoration:none; font-size:13px; cursor:pointer }
    .btn:active{ background:#f3f4f6 }
    .pager{ display:flex; align-items:center; justify-content:space-between; padding:8px 12px 12px }
    .muted{ color:#6b7280 }
    .legend .row{ display:flex; align-items:center; gap:8px; margin-top:6px }
    .legend input[type="checkbox"]{ transform: translateY(1px) }
    @media (max-width:820px){ .sidebar{ width:min(92vw, 360px); top:112px } }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend">
    <b>Legend</b>
    <div><span class="pill red"></span>Fire (red)</div>
    <div><span class="pill blue"></span>Volunteer (blue)</div>
    <div><span class="pill green"></span>Volunteer (live)</div>
    <div class="row"><span class="pill orange"></span>NASA FIRMS
      <label style="margin-left:8px"><input id="hotToggle" type="checkbox" /> show</label>
    </div>
  </div>

  <button id="toggleFab" class="toggle-fab">‚ò∞ Lists</button>

  <div id="sidebar" class="sidebar">
    <div class="tabs">
      <div id="tabVol" class="tab active">Volunteers</div>
      <div id="tabFire" class="tab">Fires</div>
    </div>
    <div class="filters">
      <input id="search" type="text" placeholder="Search..." />
      <label><input id="onlyMine" type="checkbox" /> Only my points</label>
    </div>
    <div id="list" class="list"></div>
    <div class="pager">
      <button id="prevBtn" class="btn">Prev</button>
      <div id="pageInfo" class="muted">1 / 1</div>
      <button id="nextBtn" class="btn">Next</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const DEFAULT_CENTER = [__LAT__, __LON__];
    const DEFAULT_ZOOM   = __ZOOM__;
    const MAP_TILER_KEY  = "__MAP_KEY__";
    const AUTO_REFRESH_MS = 30000;

    const urlParams = new URLSearchParams(location.search);
    const uid = urlParams.get("uid");
    const sig = urlParams.get("sig");
    const focusId = urlParams.get("focus");
    const NO_BASE = urlParams.get("nobase")==='1';

    const map = L.map('map', { zoomControl:true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    if(!NO_BASE){
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
      const key=(MAP_TILER_KEY||'').trim();
      if(key && key!=='__MAP_KEY__' && key.toLowerCase()!=='disable'){
        const mt=L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${key}`,{maxZoom:20}); mt.on('tileerror',()=>{}); mt.addTo(map);
      }
    }

    let userTouched=false, savedView={center:map.getCenter(), zoom:map.getZoom()};
    map.on('moveend zoomend', ()=>{ userTouched=true; savedView={center:map.getCenter(), zoom:map.getZoom()} });

    const sidebar=document.getElementById('sidebar'); const toggleFab=document.getElementById('toggleFab');
    function setCollapsed(v){ if(v) sidebar.classList.add('collapsed'); else sidebar.classList.remove('collapsed'); localStorage.setItem('sidebarCollapsed', v?'1':'0'); setTimeout(()=>map.invalidateSize(),200); }
    const initCollapsed = localStorage.getItem('sidebarCollapsed')==='1' || window.matchMedia('(max-width:820px)').matches;
    setCollapsed(initCollapsed);
    toggleFab.onclick=()=>setCollapsed(!sidebar.classList.contains('collapsed'));

    const tabVol=document.getElementById('tabVol'), tabFire=document.getElementById('tabFire');
    const listEl=document.getElementById('list'), searchEl=document.getElementById('search');
    const onlyMineEl=document.getElementById('onlyMine'), prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn'), pageInfo=document.getElementById('pageInfo');
    const hotToggle=document.getElementById('hotToggle');

    let activeTab=localStorage.getItem('activeTab')||'vol', pageVol=+(localStorage.getItem('pageVol')||1), pageFire=+(localStorage.getItem('pageFire')||1);
    const PAGE_SIZE=15;

    function setActiveTab(t){ activeTab=t; tabVol.classList.toggle('active', t==='vol'); tabFire.classList.toggle('active', t==='fire'); localStorage.setItem('activeTab',t); renderList(); }
    tabVol.onclick=()=>setActiveTab('vol'); tabFire.onclick=()=>setActiveTab('fire');
    searchEl.oninput=renderList; onlyMineEl.onchange=renderList;
    function persist(){ localStorage.setItem('pageVol', String(pageVol)); localStorage.setItem('pageFire', String(pageFire)); }
    prevBtn.onclick=()=>{ if(activeTab==='vol') pageVol=Math.max(1,pageVol-1); else pageFire=Math.max(1,pageFire-1); persist(); renderList(); };
    nextBtn.onclick=()=>{ const total=getFiltered(activeTab).length, max=Math.max(1, Math.ceil(total/PAGE_SIZE)); if(activeTab==='vol') pageVol=Math.min(max,pageVol+1); else pageFire=Math.min(max,pageFire+1); persist(); renderList(); };

    function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6) }
    function ts(t){ try{ return new Date(t*1000).toLocaleString() }catch(_){ return '' } }
    async function copyText(s){ try{ await navigator.clipboard.writeText(s); alert('Copied'); }catch(_){ const ta=document.createElement('textarea'); ta.value=s; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Copied'); } }
    async function delEvent(id){ if(!confirm('Delete this point?')) return; const r=await fetch(`/event/${id}?uid=${uid||''}&sig=${sig||''}`,{method:'DELETE'}); if(r.ok) await refresh(); else alert('Failed to delete'); }
    async function delLive(userId){ if(!confirm('Stop live tracking?')) return; const r=await fetch(`/live/${userId}?uid=${uid||''}&sig=${sig||''}`,{method:'DELETE'}); if(r.ok) await refresh(); else alert('Failed to stop live'); }
    window.copyText=copyText; window.delEvent=delEvent; window.delLive=delLive;

    let features=[], geoLayer=null, layerById=new Map(), hotspotsLayer=null;

    function stylePoint(f){
      const t=f.properties.type;
      const color = t==='fire' ? '#e53935' : (t==='volunteer_live' ? '#43a047' : '#1e88e5');
      return { radius:8, color, weight:2, fillColor:color, fillOpacity:.6 };
    }

    function popupHtml(f){
      const p=f.properties, lat=f.geometry.coordinates[1], lon=f.geometry.coordinates[0];
      const title = p.type==='fire' ? 'üî• Fire' : (p.type==='volunteer_live' ? 'üü¢ Volunteer (live)' : 'üìç Volunteer');
      const gmaps=`https://maps.google.com/?q=${fmt(lat)},${fmt(lon)}`;
      let html=`<div style="min-width:240px"><div style="font-weight:600">${title}${p.contact?` ¬∑ ${p.contact}`:''}</div><div style="opacity:.8">${ts(p.ts)}</div>`;
      if(p.text) html += `<div style="margin-top:4px">${p.text}</div>`;
      if(p.type==='fire' && p.photo_file_id) html += `<div style="margin-top:6px"><img src="/photo/${p.photo_file_id}" style="max-width:260px;border-radius:8px"/></div>`;
      if(p.type==='volunteer_live' && p.live_until){ html += `<div class="muted" style="margin-top:4px">Live until: ${ts(p.live_until)}</div>`; }
      html += `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"><a class="btn" href="${gmaps}" target="_blank">Google Maps</a><a class="btn" href="#" onclick="copyText('${fmt(lat)}, ${fmt(lon)}');return false;">Copy Coordinates</a></div>`;
      if(uid && sig && p.user_id && String(p.user_id)===String(uid)){
        if(p.type==='volunteer_live') html += `<div style="margin-top:8px"><a class="btn" href="#" onclick="delLive(${p.user_id});return false;">Stop Live</a></div>`;
        else html += `<div style="margin-top:8px"><a class="btn" href="#" onclick="delEvent(${p.id});return false;">Delete</a></div>`;
      }
      return html + `</div>`;
    }

    function attach(data){
      if(geoLayer){ geoLayer.remove(); layerById.clear(); }
      geoLayer=L.geoJSON(data,{
        pointToLayer:(f,latlng)=>L.circleMarker(latlng, stylePoint(f)),
        onEachFeature:(f,l)=>{ l.bindPopup(popupHtml(f)); layerById.set(String(f.properties.id), l); }
      }).addTo(map);

      if(!userTouched){
        if(data.features.length){ const b=geoLayer.getBounds(); if(b.isValid()) map.fitBounds(b.pad(0.2)); }
        else map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      }else{
        map.setView(savedView.center, savedView.zoom, {animate:false});
      }

      if(focusId && layerById.has(String(focusId))){
        const lyr=layerById.get(String(focusId)); const ll=lyr.getLatLng();
        map.setView(ll, Math.max(16, savedView.zoom||DEFAULT_ZOOM)); lyr.openPopup();
      }
    }

    function byType(t){ return features.filter(f=>f.properties.type===t) }
    function volunteersCombined(){
      return features.filter(f=>f.properties.type==='volunteer' || f.properties.type==='volunteer_live');
    }
    function getFiltered(tab){
      const q=(searchEl.value||'').toLowerCase(); const mine=onlyMineEl.checked && uid;
      const arr = (tab==='vol') ? volunteersCombined() : byType('fire');
      return arr.filter(f=>{
        const p=f.properties;
        let ok=true;
        if(mine) ok = ok && (String(p.user_id)===String(uid));
        if(q){
          const hay=[p.contact||'',p.text||'',String(p.user_id||''),String(p.id||''),String(f.geometry.coordinates[1]),String(f.geometry.coordinates[0])].join(' ').toLowerCase();
          ok = ok && hay.includes(q);
        }
        return ok;
      });
    }

    function renderList(){
      const PAGE_SIZE=15;
      const pool=getFiltered(activeTab);
      let page=(activeTab==='vol')?+(localStorage.getItem('pageVol')||1):+(localStorage.getItem('pageFire')||1);
      const totalPages=Math.max(1, Math.ceil(pool.length/PAGE_SIZE));
      page = Math.min(page, totalPages);
      if(activeTab==='vol') localStorage.setItem('pageVol', String(page)); else localStorage.setItem('pageFire', String(page));
      const start=(page-1)*PAGE_SIZE, items=pool.slice(start, start+PAGE_SIZE);

      listEl.innerHTML = items.length? '' : '<div class="muted" style="padding:12px">No items.</div>';
      for(const f of items){
        const p=f.properties, lat=f.geometry.coordinates[1], lon=f.geometry.coordinates[0];
        const kind = p.type==='volunteer' ? 'üìç Volunteer' : (p.type==='volunteer_live' ? 'üü¢ Volunteer (live)' : 'üî• Fire');
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<div><div><b>${kind}</b>${p.contact?` ¬∑ ${p.contact}`:''}</div><div class="meta">${ts(p.ts)} ¬∑ ${fmt(lat)}, ${fmt(lon)}${p.live_until?` ¬∑ until ${ts(p.live_until)}`:''}</div></div><div class="actions"><button class="btn btn-copy">Copy</button>${
          uid && p.user_id && String(p.user_id)===String(uid)
            ? (p.type==='volunteer_live' ? '<button class="btn btn-del">Stop</button>' : '<button class="btn btn-del">Delete</button>')
            : ''
        }</div>`;
        el.addEventListener('click', (e)=>{ if((e.target).closest('.actions')) return; const lyr=layerById.get(String(p.id)); if(lyr){ const ll=lyr.getLatLng(); map.setView(ll, Math.max(16, map.getZoom())); lyr.openPopup(); }});
        el.querySelector('.btn-copy').onclick=(e)=>{ e.stopPropagation(); copyText(`${fmt(lat)}, ${fmt(lon)}`); };
        const delBtn=el.querySelector('.btn-del');
        if(delBtn) delBtn.onclick=(e)=>{ e.stopPropagation(); (p.type==='volunteer_live') ? delLive(p.user_id) : delEvent(p.id); };
        listEl.appendChild(el);
      }
      pageInfo.textContent = `${page} / ${totalPages}`;
      prevBtn.disabled = (page<=1); nextBtn.disabled = (page>=totalPages);
    }

    async function loadHotspots(){
      try{
        const r=await fetch('/hotspots', {cache:'no-store'}); const gj=await r.json();
        if(hotspotsLayer){ hotspotsLayer.remove(); hotspotsLayer=null; }
        if(gj.features && gj.features.length){
          hotspotsLayer=L.geoJSON(gj, {
            pointToLayer:(f,latlng)=>L.circleMarker(latlng, {radius:5,color:'#ff6d00',weight:1,fillColor:'#ff6d00',fillOpacity:.8})
          }).addTo(map);
        }
      }catch(e){ console.error('hotspots failed', e); }
    }
    hotToggle.checked = localStorage.getItem('hotspotsEnabled')==='1';
    if(hotToggle.checked) loadHotspots();
    hotToggle.onchange = ()=>{ localStorage.setItem('hotspotsEnabled', hotToggle.checked?'1':'0'); if(hotToggle.checked) loadHotspots(); else if(hotspotsLayer){ hotspotsLayer.remove(); hotspotsLayer=null; } };
    setInterval(()=>{ if(hotToggle.checked) loadHotspots(); }, 5*60*1000);

    async function refresh(){
      try{
        const r=await fetch('/geojson', {cache:'no-store'});
        const data=await r.json();
        features=data.features||[]; attach(data); renderList();
      }catch(e){ console.error('refresh failed', e); }
    }

    let activeTab = localStorage.getItem('activeTab') || 'vol';
    setActiveTab(activeTab);
    refresh();
    setInterval(refresh, AUTO_REFRESH_MS);
  </script>
</body>
</html>
