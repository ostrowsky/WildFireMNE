<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; right: 10px; top: 10px; background: #fff; padding: 10px 12px;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1); font: 14px/1.2 system-ui, Arial;
    }
    .legend b{ display:block; margin-bottom:6px;}
    .pill { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .red{ background:#e53935; } .blue{ background:#1e88e5; } .orange{ background:#fb8c00; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; text-decoration:none; }
    .btn:active{ background:#eee; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <b>Legend</b>
  <div><span class="pill red"></span>Fire (reported)</div>
  <div><span class="pill blue"></span>Volunteer</div>
  <div><span class="pill orange"></span>Satellite hotspot</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- heatmap plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
const DEFAULT_CENTER = [__LAT__, __LON__];
const DEFAULT_ZOOM   = __ZOOM__;
const AUTO_REFRESH_MS = 10000;
const HOTSPOTS_REFRESH_MS = 120000; // 2 min

const urlParams = new URLSearchParams(location.search);
const focusId = urlParams.get("focus");
const uid = urlParams.get("uid");
const sig = urlParams.get("sig");

const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
let geoLayer = null;
let hotspotsLayer = null;
let heatLayer = null;

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// --- helpers
function fmtTS(ts){
  if(!ts) return '';
  const d = new Date(ts*1000);
  return d.toLocaleString();
}
function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }

async function copyText(t){
  try { await navigator.clipboard.writeText(t); alert("Coordinates copied"); }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand('copy'); alert("Coordinates copied"); }
    catch(_){ alert("Copy manually:\n"+t); }
    document.body.removeChild(ta);
  }
}

function contactHtml(c){
  if(!c) return '';
  if(c.startsWith('@')){
    const u = c.slice(1);
    return ` ¬∑ <a href="https://t.me/${u}" target="_blank">@${u}</a>`;
  }
  if(c.startsWith('+')) return ` ¬∑ <a href="tel:${c}">${c}</a>`;
  return ` ¬∑ ${c}`;
}

function popupHtml(feature){
  const pr = feature.properties;
  const lat = feature.geometry.coordinates[1];
  const lon = feature.geometry.coordinates[0];
  const title = (pr.type === 'fire') ? 'üî• Fire' : 'üìç Volunteer';
  const coordsText = `${fmt(lat)}, ${fmt(lon)}`;
  const gmaps = `https://maps.google.com/?q=${fmt(lat)},${fmt(lon)}`;

  let html = `
    <div style="min-width:220px">
      <div style="font-weight:600">${title}${contactHtml(pr.contact)}</div>
      <div style="opacity:.8">${fmtTS(pr.ts)}</div>
      ${pr.text ? `<div style="margin-top:4px">${pr.text}</div>` : ``}
      <div style="margin-top:6px">
        <a class="btn" href="${gmaps}" target="_blank">Google Maps</a>
        <a class="btn" href="#" onclick="copyText('${coordsText.replace(/\s/g,'')}');return false;">Copy Coordinates</a>
      </div>
  `;

  if (pr.photo_file_id) {
    html += `
      <div style="margin-top:8px">
        <img src="/photo/${pr.photo_file_id}" alt="photo" style="max-width:100%;border-radius:8px"/>
      </div>
    `;
  }

  if(uid && sig && pr.user_id && String(pr.user_id) === uid){
    html += `
      <div style="margin-top:8px">
        <a class="btn" href="#" onclick="delEvent(${pr.id});return false;">üóë Delete</a>
      </div>
    `;
  }
  html += `</div>`;
  return html;
}

async function delEvent(id){
  if(!confirm('Delete this point?')) return;
  try{
    const r = await fetch(`/event/${id}?uid=${uid}&sig=${sig}`, {method:'DELETE'});
    if(r.ok){ refresh(); }
    else { alert('Failed to delete'); }
  }catch(e){ console.error(e); alert('Network error'); }
}

// --- our bot data
async function refresh(){
  try{
    const r = await fetch('/geojson', {cache:'no-store'});
    const data = await r.json();

    if(geoLayer){ geoLayer.remove(); }
    geoLayer = L.geoJSON(data, {
      pointToLayer: (_, latlng) => L.circleMarker(latlng, {radius:8}),
      onEachFeature: (f, layer) => { layer.bindPopup(popupHtml(f)); },
      style: f => {
        const typ = f.properties.type;
        const color = (typ==='fire') ? '#e53935' : '#1e88e5';
        return { color, weight:2, fillColor:color, fillOpacity:.6 };
      }
    }).addTo(map);

    setTimeout(() => map.invalidateSize(), 0);

    if(data.features.length){
      const b = geoLayer.getBounds();
      if(b.isValid()) map.fitBounds(b.pad(0.2));
      if(focusId){
        const feat = data.features.find(x => String(x.properties.id) === String(focusId));
        if(feat){
          const latlng = L.latLng(feat.geometry.coordinates[1], feat.geometry.coordinates[0]);
          map.setView(latlng, 16);
        }
      }
    }
  }catch(e){
    console.error("refresh failed", e);
    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  }
}

// --- satellite hotspots (points + heatmap)
async function refreshHotspots(){
  try{
    const r = await fetch('/hotspots', {cache:'no-store'});
    const gj = await r.json();

    if(hotspotsLayer){ hotspotsLayer.remove(); hotspotsLayer = null; }
    if(heatLayer){ heatLayer.remove(); heatLayer = null; }

    // points
    hotspotsLayer = L.geoJSON(gj, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius:6, color:'#fb8c00', fillColor:'#fb8c00', fillOpacity:0.7, weight:1}),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const lat = f.geometry.coordinates[1];
        const lon = f.geometry.coordinates[0];
        const t  = (p.acq_date || '') + (p.acq_time ? ` ${p.acq_time}` : '');
        const info = `
          <div style="min-width:200px">
            <b>üî• Satellite hotspot</b><br>
            ${t}<br>
            ${p.brightness ? `Brightness: ${p.brightness}<br>` : ``}
            ${p.frp ? `FRP: ${p.frp}<br>` : ``}
            <a class="btn" href="https://maps.google.com/?q=${lat},${lon}" target="_blank">Google Maps</a>
          </div>`;
        layer.bindPopup(info);
      }
    });

    // heatmap
    try{
      const pts = (gj.features||[]).map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.8]);
      if(pts.length){
        heatLayer = L.heatLayer(pts, {radius: 18, blur: 16, maxZoom: 14});
      }
    }catch(e){ console.warn("heat layer error", e); }

    hotspotsLayer.addTo(map);
    if(heatLayer) heatLayer.addTo(map);

    // layers control
    if(!window._layersCtl){
      window._layersCtl = L.control.layers(
        {"OSM": osm},
        {
          "üî• Satellite Hotspots (points)": hotspotsLayer,
          "üî• Heatmap (satellite)": heatLayer
        },
        {collapsed: false}
      ).addTo(map);
    }else{
      window._layersCtl.remove();
      window._layersCtl = L.control.layers(
        {"OSM": osm},
        {
          "üî• Satellite Hotspots (points)": hotspotsLayer,
          "üî• Heatmap (satellite)": heatLayer
        },
        {collapsed: false}
      ).addTo(map);
    }
  }catch(e){
    console.error("hotspots refresh failed", e);
  }
}

refresh();
setInterval(refresh, AUTO_REFRESH_MS);

refreshHotspots();
setInterval(refreshHotspots, HOTSPOTS_REFRESH_MS);
</script>
</body>
</html>
