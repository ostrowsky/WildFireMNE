<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; margin: 0; }
    .legend, .sidebar {
      position: absolute; right: 10px; background: #fff; padding: 10px 12px;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1); font: 14px/1.2 system-ui, Arial;
    }
    .legend { top: 10px; }
    .sidebar { top: 92px; bottom: 10px; width: 270px; display: flex; flex-direction: column; }
    .legend b{ display:block; margin-bottom:6px;}
    .pill { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .red{ background:#e53935; } .blue{ background:#1e88e5; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; text-decoration:none; background:#fff; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn:active{ background:#eee; }
    .photo { max-width: 260px; display:block; margin-top:6px; border-radius:6px }

    .tabs { display:flex; gap:6px; margin-bottom:8px; }
    .tab { flex:1; text-align:center; border:1px solid #ddd; border-radius:8px; padding:6px; cursor:pointer; user-select:none; }
    .tab.active { background:#f5f5f5; font-weight:600; }
    .list { overflow:auto; border:1px solid #eee; border-radius:8px; flex:1; }
    .item { padding:8px 10px; border-bottom:1px solid #f1f1f1; cursor:pointer; }
    .item:hover { background:#fafafa; }
    .meta { opacity:.75; font-size:12px; }
    .pager { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px; }
    .pageinfo { font-variant-numeric: tabular-nums; opacity:.8; }
    @media (max-width: 900px) {
      .sidebar { width: 210px; }
      .photo { max-width: 200px; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Legend</b>
  <div><span class="pill red"></span>Fire (red)</div>
  <div><span class="pill blue"></span>Volunteer (blue)</div>
</div>

<div class="sidebar">
  <div class="tabs">
    <div id="tabVol" class="tab active">Volunteers</div>
    <div id="tabFire" class="tab">Fires</div>
  </div>
  <div id="listVol" class="list"></div>
  <div id="listFire" class="list" style="display:none"></div>

  <div class="pager">
    <button id="prevBtn" class="btn">Prev</button>
    <span id="pageInfo" class="pageinfo">1 / 1</span>
    <button id="nextBtn" class="btn">Next</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const MAP_KEY = "__MAP_KEY__"; // –∏–∑ ENV (–ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –±—ç–∫–µ–Ω–¥)
const DEFAULT_CENTER = [__LAT__, __LON__];
const DEFAULT_ZOOM   = __ZOOM__;
const AUTO_REFRESH_MS = 30000;
const PAGE_SIZE = 15; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É

const urlParams = new URLSearchParams(location.search);
const focusId = urlParams.get("focus");
const uid = urlParams.get("uid");
const sig = urlParams.get("sig");

const map = L.map('map', { zoomControl: true });

// –í—ã–±–æ—Ä —Ç–∞–π–ª–æ–≤: MapTiler –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π OSM
if (MAP_KEY && MAP_KEY !== "__MAP_KEY__") {
  L.tileLayer(
    `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MAP_KEY}`,
    { maxZoom: 20, attribution: '&copy; OSM & MapTiler' }
  ).addTo(map);
} else {
  L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 19, attribution: '&copy; OpenStreetMap' }
  ).addTo(map);
}

let geoLayer = null;
let layerById = {}; // id -> layer

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ---
let userInteracted = false;
let firstRender = true;

map.on('dragstart', () => userInteracted = true);
map.on('zoomstart', () => userInteracted = true);

function fmtTS(ts){
  if(!ts) return '';
  const d = new Date(ts*1000);
  return d.toLocaleString();
}
function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }

async function copyText(t){
  try { await navigator.clipboard.writeText(t); alert("Coordinates copied"); }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand('copy'); alert("Coordinates copied"); }
    catch(_){ alert("Copy manually:\n"+t); }
    document.body.removeChild(ta);
  }
}

function contactHtml(c){
  if(!c) return '';
  if(c.startsWith('@')){
    const u = c.slice(1);
    return ` ¬∑ <a href="https://t.me/${u}" target="_blank">@${u}</a>`;
  }
  if(c.startsWith('+')) return ` ¬∑ <a href="tel:${c}">${c}</a>`;
  return ` ¬∑ ${c}`;
}

function popupHtml(feature){
  const pr = feature.properties || {};
  const lat = feature.geometry.coordinates[1];
  const lon = feature.geometry.coordinates[0];
  const title = (pr.type === 'fire') ? 'üî• Fire' : 'üìç Volunteer';
  const coordsText = `${fmt(lat)},${fmt(lon)}`;
  const gmaps = `https://maps.google.com/?q=${fmt(lat)},${fmt(lon)}`;

  let html = `
    <div style="min-width:240px">
      <div style="font-weight:600">${title}${contactHtml(pr.contact)}</div>
      <div class="meta">${fmtTS(pr.ts)}</div>
      ${pr.text ? `<div style="margin-top:4px">${pr.text}</div>` : ``}
  `;

  if (pr.type === 'fire' && pr.photo_file_id) {
    const photoUrl = `/photo/${encodeURIComponent(pr.photo_file_id)}`;
    html += `<img class="photo" src="${photoUrl}" alt="fire photo" />`;
  }

  html += `
      <div style="margin-top:6px">
        <a class="btn" href="${gmaps}" target="_blank">Google Maps</a>
        <a class="btn" href="#" onclick="copyText('${coordsText}');return false;">Copy</a>
      </div>
  `;

  if(uid && sig && pr.user_id && String(pr.user_id) === uid){
    html += `
      <div style="margin-top:8px">
        <a class="btn" href="#" onclick="delEvent(${pr.id});return false;">Delete</a>
      </div>
    `;
  }
  html += `</div>`;
  return html;
}

async function delEvent(id){
  if(!confirm('Delete this point?')) return;
  try{
    const r = await fetch(`/event/${id}?uid=${uid}&sig=${sig}`, {method:'DELETE'});
    if(r.ok){ refresh(); }
    else { alert('Delete failed'); }
  }catch(e){ console.error(e); alert('Network error'); }
}

// ---------- –°–ø–∏—Å–∫–∏ —Å–ø—Ä–∞–≤–∞ + –ø–∞–≥–∏–Ω–∞—Ü–∏—è ----------
const $tabVol  = document.getElementById('tabVol');
const $tabFire = document.getElementById('tabFire');
const $listVol = document.getElementById('listVol');
const $listFire= document.getElementById('listFire');

const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');
const $pageInfo = document.getElementById('pageInfo');

let activeTab = 'vol'; // 'vol' | 'fire'
let volData = []; // –º–∞—Å—Å–∏–≤ features
let fireData = [];
let volPage = 1;
let firePage = 1;

$tabVol.onclick = () => { activeTab='vol'; $tabVol.classList.add('active'); $tabFire.classList.remove('active'); $listVol.style.display='block'; $listFire.style.display='none'; renderPagination(); renderVisiblePage(); };
$tabFire.onclick= () => { activeTab='fire'; $tabFire.classList.add('active'); $tabVol.classList.remove('active'); $listFire.style.display='block'; $listVol.style.display='none'; renderPagination(); renderVisiblePage(); };

$prev.onclick = () => {
  if (activeTab==='vol' && volPage>1) { volPage--; renderVisiblePage(); renderPagination(); }
  else if (activeTab==='fire' && firePage>1) { firePage--; renderVisiblePage(); renderPagination(); }
};
$next.onclick = () => {
  const totalVolPages  = Math.max(1, Math.ceil(volData.length / PAGE_SIZE));
  const totalFirePages = Math.max(1, Math.ceil(fireData.length / PAGE_SIZE));
  if (activeTab==='vol'  && volPage < totalVolPages) { volPage++; renderVisiblePage(); renderPagination(); }
  if (activeTab==='fire' && firePage < totalFirePages){ firePage++; renderVisiblePage(); renderPagination(); }
};

function h(tag, props={}, children=[]){
  const el = document.createElement(tag);
  Object.entries(props||{}).forEach(([k,v]) => { if(k==='class') el.className=v; else if(k==='html') el.innerHTML=v; else el.setAttribute(k,v); });
  (children||[]).forEach(ch => { if(typeof ch==='string') el.appendChild(document.createTextNode(ch)); else el.appendChild(ch); });
  return el;
}

function tsStr(ts){ if(!ts) return ''; const d = new Date(ts*1000); return d.toLocaleString(); }

function focusFeature(id){
  if(!geoLayer) return;
  let targetLayer = layerById[id];
  if(!targetLayer){
    geoLayer.eachLayer(ly=>{
      const pr = ly.feature?.properties;
      if(pr && String(pr.id)===String(id)) targetLayer = ly;
    });
  }
  if(targetLayer){
    const latlng = targetLayer.getLatLng ? targetLayer.getLatLng() :
                   L.latLng(targetLayer.feature.geometry.coordinates[1], targetLayer.feature.geometry.coordinates[0]);
    userInteracted = true; // —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ ¬´–Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    map.setView(latlng, Math.max(map.getZoom(), 15));
    targetLayer.openPopup && targetLayer.openPopup();
  }
}

function buildDataArrays(features){
  volData.length = 0;
  fireData.length = 0;
  for(const f of features){
    const pr = f.properties || {};
    if(pr.type === 'fire') fireData.push(f); else volData.push(f);
  }
  // –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
  volData.sort((a,b)=> (b.properties.ts||0)-(a.properties.ts||0));
  fireData.sort((a,b)=> (b.properties.ts||0)-(a.properties.ts||0));
  // –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ ‚Äî –æ—Ç–∫–∞—Ç–∏–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é
  const volPages = Math.max(1, Math.ceil(volData.length / PAGE_SIZE));
  const firePages= Math.max(1, Math.ceil(fireData.length / PAGE_SIZE));
  if (volPage > volPages) volPage = volPages;
  if (firePage > firePages) firePage = firePages;
}

function renderVisiblePage(){
  // –æ—á–∏—Å—Ç–∫–∞
  $listVol.innerHTML = '';
  $listFire.innerHTML = '';

  // Volunteers
  const vpStart = (volPage-1)*PAGE_SIZE;
  const vpEnd   = vpStart + PAGE_SIZE;
  const sliceVol = volData.slice(vpStart, vpEnd);
  for(const f of sliceVol){
    const pr = f.properties || {};
    const [lon,lat] = f.geometry.coordinates;
    const el = h('div', {class:'item'});
    el.innerHTML = `<div>üìç ${pr.contact||''}</div><div class="meta">${tsStr(pr.ts)} ¬∑ ${fmt(lat)}, ${fmt(lon)}</div>`;
    el.onclick = ()=> focusFeature(pr.id);
    $listVol.appendChild(el);
  }

  // Fires
  const fpStart = (firePage-1)*PAGE_SIZE;
  const fpEnd   = fpStart + PAGE_SIZE;
  const sliceFire = fireData.slice(fpStart, fpEnd);
  for(const f of sliceFire){
    const pr = f.properties || {};
    const [lon,lat] = f.geometry.coordinates;
    const el = h('div', {class:'item'});
    el.innerHTML = `<div>üî• ${pr.contact||''}</div><div class="meta">${tsStr(pr.ts)} ¬∑ ${fmt(lat)}, ${fmt(lon)}</div>`;
    el.onclick = ()=> focusFeature(pr.id);
    $listFire.appendChild(el);
  }

  // –æ—Ç–æ–±—Ä–∞–∑–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  if (activeTab==='vol') { $listVol.style.display='block'; $listFire.style.display='none'; }
  else { $listVol.style.display='none'; $listFire.style.display='block'; }
}

function renderPagination(){
  const totalVolPages  = Math.max(1, Math.ceil(volData.length / PAGE_SIZE));
  const totalFirePages = Math.max(1, Math.ceil(fireData.length / PAGE_SIZE));
  const page = (activeTab==='vol') ? volPage : firePage;
  const total= (activeTab==='vol') ? totalVolPages : totalFirePages;

  $pageInfo.textContent = `${page} / ${total}`;
  $prev.disabled = (page<=1);
  $next.disabled = (page>=total);
}

async function refresh(){
  try{
    const r = await fetch('/geojson', {cache:'no-store'});
    const data = await r.json();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–∏–¥, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–≤–∏–≥–∞–ª –∫–∞—Ä—Ç—É
    const currentCenter = map.getCenter();
    const currentZoom = map.getZoom();

    if(geoLayer){ geoLayer.remove(); }
    layerById = {};

    geoLayer = L.geoJSON(data, {
      pointToLayer: (f, latlng) => {
        const typ = f.properties?.type;
        const color = (typ==='fire') ? '#e53935' : '#1e88e5';
        return L.circleMarker(latlng, { radius:8, color, weight:2, fillColor:color, fillOpacity:.6 });
      },
      onEachFeature: (f, layer) => {
        const id = f.properties?.id;
        if(id!=null) layerById[id] = layer;
        layer.bindPopup(popupHtml(f));
      }
    }).addTo(map);

    // –Ω–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏ –æ—Ç—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    buildDataArrays(data.features||[]);
    renderVisiblePage();
    renderPagination();

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–æ–º: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –¥–≤–∏–≥–∞–ª
    if (data.features.length){
      if (firstRender && !userInteracted) {
        const b = geoLayer.getBounds();
        if(b.isValid()) map.fitBounds(b.pad(0.2));
      }
      if (focusId){
        const feat = data.features.find(x => String(x.properties.id) === String(focusId));
        if (feat){
          const latlng = L.latLng(feat.geometry.coordinates[1], feat.geometry.coordinates[0]);
          map.setView(latlng, 16);
        }
      }
    } else {
      if (firstRender) map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–≤–∏–≥–∞–ª ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–π –≤–∏–¥
    if (!firstRender && userInteracted) {
      map.setView(currentCenter, currentZoom, {animate:false});
    }

    firstRender = false;
  }catch(e){
    console.error("refresh failed", e);
  }
}

refresh();
setInterval(refresh, AUTO_REFRESH_MS);
</script>
</body>
</html>
