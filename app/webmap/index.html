<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wildfire Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend { background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 4px; line-height: 1.3; }
    .legend div { margin-bottom: 4px; }
    .gallery { margin-top:6px; display:flex; gap:6px; overflow-x:auto; }
    .gallery img { height: 84px; border-radius: 4px; flex: 0 0 auto; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; margin-top:6px; cursor:pointer; text-decoration:none; }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const url = new URL(location.href);
const FOCUS_ID = url.searchParams.get('focus');
const UID = url.searchParams.get('uid');
const SIG = url.searchParams.get('sig');

const CENTER = [__CENTER_LAT__, __CENTER_LON__];
const ZOOM = __CENTER_ZOOM__;

const map = L.map('map').setView(CENTER, ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

const layerFire = L.layerGroup().addTo(map);
const layerVol  = L.layerGroup().addTo(map);

const markerById = {};
let highlighted;

function linkContact(contact) {
  if (!contact) return '';
  if (contact.startsWith('@')) {
    const u = contact.slice(1);
    return `<a href="https://t.me/${u}" target="_blank">${contact}</a>`;
  }
  if (contact.startsWith('+')) {
    return `<a href="tel:${contact}">${contact}</a>`;
  }
  return contact;
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(()=>alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'); } catch(e){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: '+text); }
    document.body.removeChild(ta);
  });
}

function popupHtml(p, lat, lon) {
  const dt  = new Date(p.ts * 1000).toLocaleString();
  const coords = lat.toFixed(6)+','+lon.toFixed(6);
  const copyBtn = `<a class="btn" href="javascript:void(0)" onclick="copyText('${coords}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</a>`;
  const contact = p.contact ? `<div>–∫–æ–Ω—Ç–∞–∫—Ç: ${linkContact(p.contact)}</div>` : '';
  const delBtn = (UID && SIG && p.user_id && String(p.user_id)===String(UID))
    ? `<a class="btn" href="javascript:void(0)" onclick="delEvent('${p.id}')">–£–¥–∞–ª–∏—Ç—å</a>` : '';
  const gallery = (p.photos && p.photos > 0)
    ? `<div class="gallery" id="gal_${p.id}" data-loaded="0" data-event="${p.id}"></div>`
    : '';
  return `<b>${p.type === 'fire' ? 'üî• –û—á–∞–≥' : 'üìç –í–æ–ª–æ–Ω—Ç—ë—Ä'}</b><br>${p.text||''}<br>${dt}
          ${contact}
          ${gallery}
          <div>${copyBtn} ${delBtn}</div>`;
}

async function delEvent(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É?')) return;
  try {
    const r = await fetch(`/event/${id}?uid=${UID}&sig=${SIG}`, {method:'DELETE'});
    if (!r.ok) throw new Error('fail');
    refresh();
  } catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'); }
}

function addMarker(f) {
  const p = f.properties, g = f.geometry;
  const lat = g.coordinates[1], lon = g.coordinates[0];
  const marker = (p.type === 'fire')
    ? L.circleMarker([lat, lon], {radius:8, color:'#d00'}).bindPopup(popupHtml(p, lat, lon))
    : L.circleMarker([lat, lon], {radius:6, color:'#06c'}).bindPopup(popupHtml(p, lat, lon));
  marker.on('popupopen', () => onPopupOpen(p.id));
  markerById[p.id] = marker;
  return marker;
}

async function onPopupOpen(eventId) {
  const el = document.getElementById('gal_' + eventId);
  if (!el || el.dataset.loaded === "1") return;
  try {
    const r = await fetch(`/photos/${eventId}`, {cache:'no-store'});
    const j = await r.json();
    el.innerHTML = "";
    j.photos.forEach(ph => { const img = document.createElement('img'); img.src = ph.url; img.alt='photo'; el.appendChild(img); });
    el.dataset.loaded = "1";
  } catch(e){ console.error(e); }
}

async function refresh() {
  try {
    const r  = await fetch('/data.geojson', {cache:'no-store'});
    const gj = await r.json();
    layerFire.clearLayers(); layerVol.clearLayers();
    for (const f of gj.features) {
      const m = addMarker(f);
      if (f.properties.type === 'fire') m.addTo(layerFire);
      else m.addTo(layerVol);
    }
    focusIfNeeded();
  } catch(e){ console.error(e); }
}

function focusIfNeeded() {
  if (FOCUS_ID && markerById[FOCUS_ID]) {
    const m = markerById[FOCUS_ID];
    const latlng = m.getLatLng();
    map.setView(latlng, Math.max(map.getZoom(), 15), {animate:true});
    m.openPopup();
    pulse(latlng);
  }
}

function pulse(latlng) {
  if (highlighted) { map.removeLayer(highlighted); }
  highlighted = L.circle(latlng, {radius: 50, color: '#ff7800', weight: 2, fillOpacity: 0.15}).addTo(map);
  let r = 50;
  const t = setInterval(()=>{ r += 25; if (r > 200) { clearInterval(t); return; } if (highlighted) highlighted.setRadius(r); }, 200);
}

refresh();
setInterval(refresh, 30000);

const legend = L.control({position:'topright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = '<div><b>–õ–µ–≥–µ–Ω–¥–∞</b></div>' +
    '<div>üî• –û—á–∞–≥ (–∫—Ä–∞—Å–Ω—ã–π)</div>' +
    '<div>üìç –í–æ–ª–æ–Ω—Ç—ë—Ä (—Å–∏–Ω–∏–π)</div>';
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
