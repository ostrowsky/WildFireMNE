<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; right: 10px; top: 10px; background: #fff; padding: 10px 12px;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1); font: 14px/1.2 system-ui, Arial;
    }
    .legend b{ display:block; margin-bottom:6px;}
    .pill { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .red{ background:#e53935; } .blue{ background:#1e88e5; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; text-decoration:none; }
    .btn:active{ background:#eee; }
    .photo { max-width: 260px; display:block; margin-top:6px; border-radius:6px }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <b>Legend</b>
  <div><span class="pill red"></span>Fire (red)</div>
  <div><span class="pill blue"></span>Volunteer (blue)</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ====== MAP API KEY hardcoded here ====== */
const MAP_KEY = "172f6ffa32d48a50ce4f15f8e3a550d4";
/* ======================================== */

const DEFAULT_CENTER = [__LAT__, __LON__];   // –±—É–¥—É—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∫—ç–Ω–¥–æ–º
const DEFAULT_ZOOM   = __ZOOM__;
const AUTO_REFRESH_MS = 30000;

const urlParams = new URLSearchParams(location.search);
const focusId = urlParams.get("focus");
const uid = urlParams.get("uid");
const sig = urlParams.get("sig");

const map = L.map('map', { zoomControl: true });

/* MapTiler tiles */
L.tileLayer(
  `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MAP_KEY}`,
  {
    maxZoom: 20,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> ' +
      '& <a href="https://www.maptiler.com/copyright/">MapTiler</a>'
  }
).addTo(map);

let geoLayer = null;

function fmtTS(ts){
  if(!ts) return '';
  const d = new Date(ts*1000);
  return d.toLocaleString();
}
function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }

async function copyText(t){
  try { await navigator.clipboard.writeText(t); alert("Coordinates copied"); }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand('copy'); alert("Coordinates copied"); }
    catch(_){ alert("Copy manually:\n"+t); }
    document.body.removeChild(ta);
  }
}

function contactHtml(c){
  if(!c) return '';
  if(c.startsWith('@')){
    const u = c.slice(1);
    return ` ¬∑ <a href="https://t.me/${u}" target="_blank">@${u}</a>`;
  }
  if(c.startsWith('+')) return ` ¬∑ <a href="tel:${c}">${c}</a>`;
  return ` ¬∑ ${c}`;
}

function popupHtml(feature){
  const pr = feature.properties || {};
  const lat = feature.geometry.coordinates[1];
  const lon = feature.geometry.coordinates[0];
  const title = (pr.type === 'fire') ? 'üî• Fire' : 'üìç Volunteer';
  const coordsText = `${fmt(lat)},${fmt(lon)}`;
  const gmaps = `https://maps.google.com/?q=${fmt(lat)},${fmt(lon)}`;

  let html = `
    <div style="min-width:240px">
      <div style="font-weight:600">${title}${contactHtml(pr.contact)}</div>
      <div style="opacity:.8">${fmtTS(pr.ts)}</div>
      ${pr.text ? `<div style="margin-top:4px">${pr.text}</div>` : ``}
  `;

  if (pr.type === 'fire' && pr.photo_file_id) {
    const photoUrl = `/photo/${encodeURIComponent(pr.photo_file_id)}`;
    html += `<img class="photo" src="${photoUrl}" alt="fire photo" />`;
  }

  html += `
      <div style="margin-top:6px">
        <a class="btn" href="${gmaps}" target="_blank">Google Maps</a>
        <a class="btn" href="#" onclick="copyText('${coordsText}');return false;">Copy</a>
      </div>
  `;

  if(uid && sig && pr.user_id && String(pr.user_id) === uid){
    html += `
      <div style="margin-top:8px">
        <a class="btn" href="#" onclick="delEvent(${pr.id});return false;">Delete</a>
      </div>
    `;
  }
  html += `</div>`;
  return html;
}

async function delEvent(id){
  if(!confirm('Delete this point?')) return;
  try{
    const r = await fetch(`/event/${id}?uid=${uid}&sig=${sig}`, {method:'DELETE'});
    if(r.ok){ refresh(); }
    else { alert('Delete failed'); }
  }catch(e){ console.error(e); alert('Network error'); }
}

async function refresh(){
  try{
    const r = await fetch('/geojson', {cache:'no-store'});
    const data = await r.json();

    if(geoLayer){ geoLayer.remove(); }
    geoLayer = L.geoJSON(data, {
      pointToLayer: (f, latlng) => {
        const typ = f.properties?.type;
        const color = (typ==='fire') ? '#e53935' : '#1e88e5';
        return L.circleMarker(latlng, { radius:8, color, weight:2, fillColor:color, fillOpacity:.6 });
      },
      onEachFeature: (f, layer) => layer.bindPopup(popupHtml(f))
    }).addTo(map);

    if(data.features.length){
      const b = geoLayer.getBounds();
      if(b.isValid()) map.fitBounds(b.pad(0.2));
      if(focusId){
        const feat = data.features.find(x => String(x.properties.id) === String(focusId));
        if(feat){
          const latlng = L.latLng(feat.geometry.coordinates[1], feat.geometry.coordinates[0]);
          map.setView(latlng, 16);
        }
      }
    }else{
      map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    }
  }catch(e){
    console.error("refresh failed", e);
  }
}

refresh();
setInterval(refresh, AUTO_REFRESH_MS);
</script>
</body>
</html>
