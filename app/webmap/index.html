<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ñ–∏–≤–∞—è –∫–∞—Ä—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; right: 10px; top: 10px; background: #fff; padding: 10px 12px;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1); font: 14px/1.2 system-ui, Arial;
    }
    .legend b{ display:block; margin-bottom:6px;}
    .pill { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .red{ background:#e53935; } .blue{ background:#1e88e5; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; text-decoration:none; }
    .btn:active{ background:#eee; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <b>Legend</b>
  <div><span class="pill red"></span>Fire (red)</div>
  <div><span class="pill blue"></span>Volunteer (blue)</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const DEFAULT_CENTER = [42.179, 18.942];
const DEFAULT_ZOOM   = 12;
const AUTO_REFRESH_MS = 30000;

const urlParams = new URLSearchParams(location.search);
const focusId = urlParams.get("focus");
const uid = urlParams.get("uid");
const sig = urlParams.get("sig");

// –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∑–∞–¥–∞–Ω–æ —Å—Ä–∞–∑—É
const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
let geoLayer = null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

function fmtTS(ts){
  if(!ts) return '';
  const d = new Date(ts*1000);
  return d.toLocaleString();
}
function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }

async function copyText(t){
  try { await navigator.clipboard.writeText(t); alert("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"); }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand('copy'); alert("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"); }
    catch(_){ alert("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n"+t); }
    document.body.removeChild(ta);
  }
}

function contactHtml(c){
  if(!c) return '';
  if(c.startsWith('@')){
    const u = c.slice(1);
    return ` ¬∑ <a href="https://t.me/${u}" target="_blank">@${u}</a>`;
  }
  if(c.startsWith('+')) return ` ¬∑ <a href="tel:${c}">${c}</a>`;
  return ` ¬∑ ${c}`;
}

function markerFor(feature){
  const typ = feature.properties.type;
  const color = (typ === 'fire') ? '#e53935' : '#1e88e5';
  return L.circleMarker(
    [feature.geometry.coordinates[1], feature.geometry.coordinates[0]],
    { radius: 8, color, weight: 2, fillColor: color, fillOpacity: 0.6 }
  );
}

function popupHtml(feature){
  const pr = feature.properties;
  const lat = feature.geometry.coordinates[1];
  const lon = feature.geometry.coordinates[0];
  const title = (pr.type === 'fire') ? 'üî• Fire' : 'üìç Volunteer';
  const coordsText = `${fmt(lat)}, ${fmt(lon)}`;
  const gmaps = `https://maps.google.com/?q=${fmt(lat)},${fmt(lon)}`;

  let html = `
    <div style="min-width:220px">
      <div style="font-weight:600">${title}${contactHtml(pr.contact)}</div>
      <div style="opacity:.8">${fmtTS(pr.ts)}</div>
      ${pr.text ? `<div style="margin-top:4px">${pr.text}</div>` : ``}
      <div style="margin-top:6px">
        <a class="btn" href="${gmaps}" target="_blank">Google Maps</a>
        <a class="btn" href="#" onclick="copyText('${coordsText.replace(/\s/g,'')}');return false;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</a>
      </div>
  `;

  if(uid && sig && pr.user_id && String(pr.user_id) === uid){
    html += `
      <div style="margin-top:8px">
        <a class="btn" href="#" onclick="delEvent(${pr.id});return false;">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    `;
  }
  html += `</div>`;
  return html;
}

async function delEvent(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É?')) return;
  try{
    const r = await fetch(`/event/${id}?uid=${uid}&sig=${sig}`, {method:'DELETE'});
    if(r.ok){ refresh(); }
    else { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'); }
  }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
}

async function refresh(){
  try{
    const r = await fetch('/geojson', {cache:'no-store'});
    const data = await r.json();

    if(geoLayer){ geoLayer.remove(); }
    geoLayer = L.geoJSON(data, {
      pointToLayer: (_, latlng) => L.circleMarker(latlng, {radius:8}),
      onEachFeature: (f, layer) => {
        const html = popupHtml(f);
        layer.bindPopup(html);
      },
      style: f => {
        const typ = f.properties.type;
        const color = (typ==='fire') ? '#e53935' : '#1e88e5';
        return { color, weight:2, fillColor:color, fillOpacity:.6 };
      }
    }).addTo(map);

    setTimeout(() => map.invalidateSize(), 0);

    if(data.features.length){
      const b = geoLayer.getBounds();
      if(b.isValid()) map.fitBounds(b.pad(0.2));
      if(focusId){
        const feat = data.features.find(x => String(x.properties.id) === String(focusId));
        if(feat){
          const latlng = L.latLng(feat.geometry.coordinates[1], feat.geometry.coordinates[0]);
          map.setView(latlng, 16);
        }
      }
    }
  }catch(e){
    console.error("refresh failed", e);
    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  }
}

refresh();
setInterval(refresh, AUTO_REFRESH_MS);
</script>
</body>
</html>
