<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }

    /* Legend */
    .legend{
      position:absolute; right:14px; top:14px; z-index:700;
      background:#fff; border-radius:12px; padding:12px 14px;
      box-shadow:0 6px 20px rgba(0,0,0,.12); font:14px/1.2 system-ui, Arial;
    }
    .legend b{ display:block; margin-bottom:8px; }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; vertical-align:middle; }
    .red{ background:#e53935; } .blue{ background:#1e88e5; }

    /* Sidebar */
    .sidebar{
      position:absolute; right:14px; top:102px; bottom:14px; width:320px; z-index:700;
      background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.12);
      display:flex; flex-direction:column; overflow:hidden;
      transition:transform .2s ease, opacity .2s ease;
    }
    .sidebar.collapsed{ transform:translateX(calc(100% + 14px)); opacity:.0; pointer-events:none; }
    .tabs{ display:flex; gap:8px; padding:12px; }
    .tab{ flex:1; text-align:center; padding:10px 12px; border-radius:10px; background:#f2f3f5; cursor:pointer; user-select:none; }
    .tab.active{ background:#e7efff; color:#0b57d0; font-weight:600; }
    .toolbar{ display:flex; align-items:center; gap:10px; padding:0 12px 10px 12px; }
    .search{ flex:1; height:36px; border:1px solid #e2e2e2; border-radius:10px; padding:0 10px; outline:none; }
    .list{ flex:1; overflow:auto; padding:0 12px 12px 12px; }
    .item{
      border:1px solid #ececec; border-radius:10px; padding:10px 10px;
      margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer;
    }
    .item .meta{ font-size:12px; opacity:.75; }
    .pill{ font-size:12px; padding:2px 6px; border-radius:999px; background:#f3f5f7; }
    .btn{ border:1px solid #ddd; border-radius:8px; padding:6px 10px; background:#fff; cursor:pointer; text-decoration:none; }
    .btn:active{ background:#f1f1f1; }
    .pager{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 12px 12px; }
    .pager .info{ opacity:.7; }

    /* Toggle button (floating) */
    .toggle{
      position:absolute; right:14px; top:102px;
      z-index:705; width:40px; height:40px; border-radius:10px;
      border:1px solid #e3e3e3; background:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow:0 6px 20px rgba(0,0,0,.12); cursor:pointer; user-select:none;
      transition:transform .2s ease;
    }
    .toggle:hover{ transform:scale(1.03); }
    .toggle .bar{ width:18px; height:2px; background:#333; margin:2px 0; display:block; }
    .toggle.hidden{ display:none; }

    /* Mobile: sidebar collapsed by default; toggle visible */
    @media (max-width: 940px) {
      .sidebar { width: 88vw; }
      .toggle { display:flex; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Legend</b>
  <div><span class="dot red"></span>Fire (red)</div>
  <div><span class="dot blue"></span>Volunteer (blue)</div>
</div>

<div id="toggle" class="toggle" title="Show/Hide panel">
  <span class="bar"></span><span class="bar"></span><span class="bar"></span>
</div>

<div id="sidebar" class="sidebar">
  <div class="tabs">
    <div class="tab active" data-tab="vols">Volunteers</div>
    <div class="tab" data-tab="fires">Fires</div>
  </div>
  <div class="toolbar">
    <input id="search" class="search" placeholder="Search‚Ä¶">
    <label style="display:flex; align-items:center; gap:6px; white-space:nowrap; font:13px system-ui,Arial;">
      <input type="checkbox" id="mine"> Only my points
    </label>
  </div>
  <div id="list" class="list"></div>
  <div class="pager">
    <button id="prev" class="btn">Prev</button>
    <div class="info" id="pageinfo">1 / 1</div>
    <button id="next" class="btn">Next</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===== Map constants (–ø–æ–¥–º–µ–Ω—è—é—Ç—Å—è –±–µ–∫–µ–Ω–¥–æ–º) ===== */
const DEFAULT_CENTER = [__LAT__, __LON__];
const DEFAULT_ZOOM   = __ZOOM__;
const MAP_TILER_KEY  = "__MAP_KEY__";

/* ===== State ===== */
const AUTO_REFRESH_MS = 30000;
const PAGE_SIZE = 15;
const urlParams = new URLSearchParams(location.search);
const uid = urlParams.get("uid");
const sig = urlParams.get("sig");
const focusId = urlParams.get("focus");
const forceTiles = urlParams.get("tiles"); // 'osm' | 'maptiler'

let map, geoLayer = null;
let movedByUser = false;
let allFeatures = []; // last /geojson
let layerById = new Map();

let tab = localStorage.getItem("tab") || "vols";     // vols|fires
let pageVols = +(localStorage.getItem("pageVols")||1);
let pageFires= +(localStorage.getItem("pageFires")||1);
let collapsed = JSON.parse(localStorage.getItem("collapsed") || (window.matchMedia("(max-width: 940px)").matches ? "true" : "false"));

/* ===== Helpers ===== */
function fmtTS(ts){ if(!ts) return ""; return new Date(ts*1000).toLocaleString(); }
function fmt(v){ return (Math.round(v*1e6)/1e6).toFixed(6); }
function coordPair(feat){ const [lon,lat]=feat.geometry.coordinates; return `${fmt(lat)}, ${fmt(lon)}`; }

async function copyText(t){
  try { await navigator.clipboard.writeText(t); }
  catch(e){
    const ta = document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.opacity=0;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  }
}

/* ===== Tile provider: MapTiler (if key) with fallback to OSM ===== */
function addTiles(m) {
  const key = (MAP_TILER_KEY||"").trim();
  const wantMapTiler = (forceTiles === "maptiler") ||
                       (!forceTiles && key && key !== "__MAP_KEY__" && key.toLowerCase() !== "disable");
  if (wantMapTiler) {
    const mtUrl = `https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${key}`;
    const layer = L.tileLayer(mtUrl, {
      maxZoom: 20, tileSize:256, crossOrigin:true,
      attribution: '&copy; OSM & MapTiler'
    });
    layer.on("tileerror", () => {
      m.removeLayer(layer);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution:'&copy; OpenStreetMap contributors'
      }).addTo(m);
    });
    layer.addTo(m);
  } else {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution:'&copy; OpenStreetMap contributors'
    }).addTo(m);
  }
}

/* ===== Map init ===== */
map = L.map('map', { zoomControl:true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
addTiles(map);

map.on("movestart zoomstart", ()=>{ movedByUser = true; saveView(); });
map.on("moveend zoomend", saveView);

function saveView(){
  const c = map.getCenter();
  localStorage.setItem("view", JSON.stringify({lat:c.lat, lon:c.lng, z: map.getZoom()}));
}
(function restoreView(){
  const s = localStorage.getItem("view");
  if (s) {
    try { const v = JSON.parse(s); map.setView([v.lat, v.lon], v.z); } catch(_) {}
  }
})();

/* ===== Sidebar toggle ===== */
const sidebar = document.getElementById("sidebar");
const toggle  = document.getElementById("toggle");
function applyCollapsed(){
  if (collapsed) { sidebar.classList.add("collapsed"); }
  else { sidebar.classList.remove("collapsed"); }
  localStorage.setItem("collapsed", JSON.stringify(collapsed));
}
toggle.addEventListener("click", () => { collapsed = !collapsed; applyCollapsed(); });
applyCollapsed();

/* ===== UI refs ===== */
const listEl  = document.getElementById("list");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const pageInfo= document.getElementById("pageinfo");
const searchEl= document.getElementById("search");
const mineEl  = document.getElementById("mine");
const tabs = document.querySelectorAll(".tab");

/* tabs switching */
function setTab(t){
  tab = t; localStorage.setItem("tab", tab);
  tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
  renderList();
}
tabs.forEach(x => x.addEventListener("click", ()=> setTab(x.dataset.tab)));
setTab(tab);

/* pagination per tab */
function getPage(){ return tab==="vols" ? pageVols : pageFires; }
function setPage(n){ if(tab==="vols"){ pageVols=n; localStorage.setItem("pageVols", String(n)); } else { pageFires=n; localStorage.setItem("pageFires", String(n)); } }

/* filters */
searchEl.addEventListener("input", renderList);
mineEl.addEventListener("change", renderList);

/* ===== Data render ===== */
function contactHtml(c){
  if(!c) return "";
  if (c.startsWith("@")) {
    const u = c.slice(1);
    return ` ¬∑ <a href="https://t.me/${u}" target="_blank">@${u}</a>`;
  }
  if (c.startsWith("+")) return ` ¬∑ <a href="tel:${c}">${c}</a>`;
  return ` ¬∑ ${c}`;
}

function popupHtml(f){
  const p = f.properties;
  const coords = coordPair(f);
  const gmaps = `https://maps.google.com/?q=${coords.replace(' ','')}`;
  let html = `
    <div style="min-width:220px">
      <div style="font-weight:600">${p.type==='fire'?'üî• Fire':'üìç Volunteer'}${contactHtml(p.contact)}</div>
      <div style="opacity:.75">${fmtTS(p.ts)}</div>
      ${p.text ? `<div style="margin-top:4px">${p.text}</div>` : ``}
      ${p.photo_file_id ? `<div style="margin-top:8px"><img src="/photo/${p.photo_file_id}" style="max-width:260px;border-radius:8px;"></div>` : ``}
      <div style="margin-top:8px; display:flex; gap:8px;">
        <a class="btn" href="${gmaps}" target="_blank">Google Maps</a>
        <a class="btn" href="#" onclick="copyText('${coords.replace(/\s/g,'')}');return false;">Copy</a>
      </div>
    </div>`;
  if(uid && sig && p.user_id && String(p.user_id)===uid){
    html += `<div style="margin-top:8px"><a class="btn" href="#" onclick="delEvent(${p.id});return false;">Delete</a></div>`;
  }
  return html;
}

async function delEvent(id){
  if(!confirm("Delete this point?")) return;
  try{
    const r = await fetch(`/event/${id}?uid=${uid||""}&sig=${sig||""}`, {method:"DELETE"});
    if(r.ok){ refresh(); }
    else { alert("Failed to delete"); }
  }catch(e){ console.error(e); alert("Network error"); }
}

function featureMatches(f){
  const p = f.properties;
  const q = searchEl.value.trim().toLowerCase();
  if (mineEl.checked && uid && String(p.user_id) !== uid) return false;
  if (!q) return true;
  const fields = [
    p.contact||"", p.text||"", String(p.user_id||""), coordPair(f)
  ].join(" ").toLowerCase();
  return fields.includes(q);
}

function filtered(){
  const arr = allFeatures.filter(featureMatches);
  return tab==="vols" ? arr.filter(x=>x.properties.type==='volunteer')
                      : arr.filter(x=>x.properties.type==='fire');
}

function renderList(){
  const items = filtered();
  const total = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
  let page = Math.min(getPage(), total); if (page<1) page=1; setPage(page);

  const off = (page-1)*PAGE_SIZE;
  const slice = items.slice(off, off+PAGE_SIZE);

  listEl.innerHTML = "";
  slice.forEach(f=>{
    const p = f.properties;
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div>
        <div><span class="pill">${p.type==='fire'?'üî• Fire':'üìç Volunteer'}</span> ${contactHtml(p.contact)}</div>
        <div class="meta">${fmtTS(p.ts)} ¬∑ ${coordPair(f)}</div>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="btn btn-copy">Copy</button>
        ${uid && String(p.user_id)===uid ? '<button class="btn btn-del">Delete</button>':''}
      </div>
    `;
    el.addEventListener("click", (ev)=>{
      if (ev.target.closest(".btn")) return; // –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
      const layer = layerById.get(p.id);
      if (layer){ map.setView(layer.getLatLng(), Math.max(map.getZoom(), 15)); layer.openPopup(); }
      collapsed = true; applyCollapsed(); // –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ ‚Äî —Å–ø—Ä—è—Ç–∞—Ç—å
    });
    el.querySelector(".btn-copy").addEventListener("click", (ev)=>{ ev.stopPropagation(); copyText(coordPair(f).replace(/\s/g,'')); });
    const delBtn = el.querySelector(".btn-del");
    if (delBtn) delBtn.addEventListener("click", async (ev)=>{ ev.stopPropagation(); await delEvent(p.id); });
    listEl.appendChild(el);
  });

  pageInfo.textContent = `${page} / ${total}`;
  prevBtn.disabled = page<=1; nextBtn.disabled = page>=total;
}
prevBtn.addEventListener("click", ()=>{ setPage(getPage()-1); renderList(); });
nextBtn.addEventListener("click", ()=>{ setPage(getPage()+1); renderList(); });

function buildLayer(data){
  if(geoLayer){ geoLayer.remove(); layerById.clear(); }
  geoLayer = L.geoJSON(data, {
    pointToLayer: (f, latlng) => {
      const typ = f.properties.type;
      const color = (typ==='fire') ? '#e53935' : '#1e88e5';
      return L.circleMarker(latlng, { radius:8, color, weight:2, fillColor:color, fillOpacity:.6 });
    },
    onEachFeature: (f, layer) => {
      layer.bindPopup(popupHtml(f));
      layerById.set(f.properties.id, layer);
    }
  }).addTo(map);
}

async function refresh(){
  try{
    const r = await fetch('/geojson', {cache:'no-store'});
    const data = await r.json();
    allFeatures = data.features||[];
    const hadUserMove = movedByUser;

    buildLayer(data);
    renderList();

    if(!hadUserMove){
      if(focusId){
        const feat = allFeatures.find(x=>String(x.properties.id)===String(focusId));
        if (feat){
          const [lon,lat]=feat.geometry.coordinates;
          map.setView([lat,lon], 16);
          const layer = layerById.get(feat.properties.id); if(layer) layer.openPopup();
        }
      } else if (allFeatures.length) {
        const b = geoLayer.getBounds(); if (b.isValid()) map.fitBounds(b.pad(0.2));
      } else {
        // –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥ –∫–∞–∫ –µ—Å—Ç—å
      }
    }
  }catch(e){ console.error("refresh failed", e); }
}

refresh();
setInterval(refresh, AUTO_REFRESH_MS);
</script>
</body>
</html>
